<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>人生会議（議題＋返信形式デモ）</title>
<style>
  :root{--fg:#111;--muted:#6b7280;--bd:#e5e7eb;--bg:#fff}
  html,body{height:100%}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'Hiragino Kaku Gothic ProN','Noto Sans JP','Yu Gothic',sans-serif;margin:0;color:var(--fg);background:var(--bg)}
  .container{max-width:760px;margin:0 auto;padding:16px}
  h1{font-size:28px;margin:0 0 6px}
  h2{font-size:20px;margin:0 0 10px}
  h3{font-size:16px;margin:0 0 6px}
  .meta{font-size:12px;color:var(--muted)}
  .grid{display:grid;gap:12px}
  .card{padding:14px;border:1px solid var(--bd);border-radius:10px;text-decoration:none;display:block}
  .thread{display:block;padding:12px 0;border-bottom:1px solid var(--bd);text-decoration:none}
  .thread .title{font-weight:600}
  .thread .meta{font-size:12px;color:var(--muted);margin-top:4px}
  .post{padding:12px 0;border-bottom:1px solid var(--bd)}
  .post .meta{font-size:12px;color:var(--muted);margin-bottom:6px}
  .post .body{line-height:1.7;word-break:break-word;white-space:pre-wrap}
  .reply{padding:8px 0 8px 16px;border-left:3px solid #f1f5f9;margin-top:6px}
  .btn{display:inline-block;padding:9px 13px;border:1px solid var(--bd);border-radius:8px;background:#fff;cursor:pointer}
  .input, textarea{width:100%;padding:10px;border:1px solid var(--bd);border-radius:8px;box-sizing:border-box}
  nav{padding:10px 16px;border-bottom:1px solid var(--bd);position:sticky;top:0;background:#fff}
  nav a{text-decoration:none;margin-right:12px}
  .spacer{height:4px}

  /* スレ一覧をカード風に */
  .thread-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 16px;
    margin-top: 12px;
  }
  .thread-card {
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    padding: 16px;
    cursor: pointer;
    transition: all 0.2s ease-in-out;
  }
  .thread-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0,0,0,0.08);
  }
  .thread-title { font-weight: 600; font-size: 15px; color:#111; margin-bottom:6px; }
  .thread-meta  { font-size: 12px; color:#6b7280; }
</style>
</head>
<body>
<nav>
  <a href="#" onclick="startApp()">人生会議</a>
  <a href="javascript:history.back()">戻る</a>
</nav>
<div id="app" class="container"></div>

<script>
// ===== Utilities =====
function esc(s){
  return String(s||'').replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
  }[m]));
}
function fmt(d){return new Date(d).toLocaleString();}
function rid(){return Math.random().toString(36).slice(2,8).toUpperCase();}

// ===== Threads (by age) in localStorage =====
function threadsKey(age){ return "jk_threads_" + age; }
function loadThreads(age){
  const k = threadsKey(age);
  if(!localStorage.getItem(k)){
    const seed = {
      "27":[{id:"t27_1", age:"27", title:"27歳の転職リアル", replies:12, updated_at:"2025-10-26T12:00:00Z", topic_pid:"p_seed27"}],
      "28":[{id:"t28_1", age:"28", title:"28歳の貯金額どう？", replies:21, updated_at:"2025-10-26T09:30:00Z", topic_pid:"p_seed28"}],
      "29":[{id:"t29_1", age:"29", title:"29歳、結婚観語ろう", replies:8,  updated_at:"2025-10-25T22:10:00Z", topic_pid:"p_seed29"}],
      "30":[{id:"t30_1", age:"30", title:"30歳のキャリア再設計", replies:5,  updated_at:"2025-10-24T18:00:00Z", topic_pid:"p_seed30"}]
    };
    const arr = seed[age] || [];
    localStorage.setItem(k, JSON.stringify(arr));
    // それぞれに議題ポストを最低1つ作っておく
    arr.forEach(t=>{
      const pk = postsKey(t.id);
      if(!localStorage.getItem(pk)){
        localStorage.setItem(pk, JSON.stringify([
          {pid:t.topic_pid, body:"正直つらい。転職って現実的？", anon_id:"A7XG3F", created_at:"2025-10-26T11:55:00Z", is_topic:true, title:t.title}
        ]));
      }
    });
  }
  try { return JSON.parse(localStorage.getItem(k) || "[]"); } catch(e){ return []; }
}
function saveThreads(age, arr){ localStorage.setItem(threadsKey(age), JSON.stringify(arr)); }

// ===== Posts per thread =====
function postsKey(tid){ return "jk_posts_" + tid; }
function loadPosts(tid){
  const k = postsKey(tid);
  try { return JSON.parse(localStorage.getItem(k)||"[]"); } catch(e){ return []; }
}
function savePosts(tid, arr){ localStorage.setItem(postsKey(tid), JSON.stringify(arr)); }

// ===== Replies per post =====
function repliesKey(tid){ return "jk_replies_" + tid; }
function loadReplies(tid){
  try { return JSON.parse(localStorage.getItem(repliesKey(tid)) || "{}"); } catch(e){ return {}; }
}
function saveReplies(tid, obj){
  localStorage.setItem(repliesKey(tid), JSON.stringify(obj));
}

// ===== Views =====
function ViewTop(){
  return `
    <h1>人生会議</h1>
    <p class="meta">年齢別に本音で語る匿名板。まずは年代を選んでね。</p>
    <div class="grid"><a class="card" href="#" onclick="showList('30')"><b>30歳の部屋</b></a></div>
    <div class="grid"><a class="card" href="#" onclick="showList('29')"><b>29歳の部屋</b></a></div>
    <div class="grid"><a class="card" href="#" onclick="showList('28')"><b>28歳の部屋</b></a></div>
    <div class="grid"><a class="card" href="#" onclick="showList('27')"><b>27歳の部屋</b></a></div>
  `;
}

function ViewList(age){
  const list = loadThreads(age);
  const items = list.map(t=>`
    <div class="card thread-card" onclick="showThread('${t.id}','${age}')">
      <div class="thread-title">${esc(t.title)}</div>
      <div class="thread-meta">${t.replies||0}件｜最終更新 ${fmt(t.updated_at||new Date().toISOString())}</div>
    </div>
  `).join("");

  const createUI = `
    <div class="spacer"></div>
    <div style="margin-top:20px;padding-top:20px;border-top:1px solid #e5e7eb">
      <h3>新規スレ作成（＝議題作成）</h3>
      <input id="newTitle" class="input" placeholder="議題タイトル（例：${age}歳の結婚どうしてる？）" />
      <textarea id="newBody" class="input" rows="4" style="margin-top:8px" placeholder="議題内容（例：30歳独身。良い出会いがなくて困ってます。皆さんはどうしてますか？）"></textarea>
      <div style="margin-top:8px">
        <button class="btn" onclick="createThread('${age}')">作成する</button>
        <span id="createStatus" class="meta"></span>
      </div>
    </div>`;

  return `
    <h2>${age}歳 のスレッド</h2>
    <div class="thread-grid">
      ${items || `<div class="meta">まだスレがありません</div>`}
    </div>
    ${createUI}
    <div style="margin-top:16px"><a class="btn" href="#" onclick="startApp()">← 年代を選び直す</a></div>
  `;
}

function normalizeLeading(s){
  // 各行の先頭にある半角/全角スペースを除去
  return String(s||"").replace(/^[\s\u3000]+/gm, "");
}

function ViewThread(tid, age){
  const list = loadThreads(age);
  const found = list.find(t=>t.id===tid);
  const title = found ? found.title : "スレッド";

  const posts = loadPosts(tid);
  // この形式では「議題ポスト（先頭・is_topic=true）」のみ表示し、その内容に返信していく
  const topic = posts.find(p=>p.is_topic) || posts[0];

  const repliesMap = loadReplies(tid);
  const reps = (repliesMap[topic?.pid] || []);
  const repliesHtml = reps.map(r=>`
      <div class="reply">
        <div class="meta">↳ 返信｜ID:${r.anon_id}｜${fmt(r.created_at)}</div>
        <div class="body">${esc(r.body)}</div>
      </div>
  `).join("");

  const topicHtml = topic ? `
  <div class="post">
    <div class="meta">ID:${topic.anon_id}｜${fmt(topic.created_at)}</div>
    <div class="body">
      ${esc(normalizeLeading(topic.body))}
    </div>
    <div style="margin-top:8px">
      <button class="btn" onclick="toggleReply('${topic.pid}')">返信する</button>
    </div>
    <div id="replyBox_${topic.pid}" style="display:none;margin-top:8px">
      <textarea id="replyBody_${topic.pid}" class="input" rows="3" placeholder="返信内容"></textarea>
      <div style="margin-top:6px;display:flex;gap:8px;align-items:center">
        <button class="btn" onclick="submitReply('${tid}','${age}','${topic.pid}')">返信を送信</button>
        <span id="replyStatus_${topic.pid}" class="meta"></span>
      </div>
    </div>
    ${repliesHtml || ""}
  </div>
` : `<div class="meta">議題が見つかりません</div>`;

  return `
    <a class="btn" href="#" onclick="showList('${age}')">← 一覧に戻る</a>
    <h2>${esc(title)}</h2>
    ${topicHtml}
    <!-- この形式では新規投稿フォーム（別トピ立て）は一覧画面にのみ存在。ここには置かない -->
  `;
}

// ===== Controllers =====
function mount(html){ document.getElementById("app").innerHTML = html; }
function startApp(){ mount(ViewTop()); }
function showList(age){ mount(ViewList(age)); }
function showThread(tid, age){ mount(ViewThread(tid, age)); }

function createThread(age){
  const titleEl = document.getElementById("newTitle");
  const bodyEl  = document.getElementById("newBody");
  const status  = document.getElementById("createStatus");

  const title = (titleEl?.value || "").trim();
  const body  = (bodyEl?.value  || "").trim();

  if(!title){ status.textContent="タイトルを入力してください"; return; }
  if(!body){  status.textContent="内容を入力してください"; return; }

  const arr = loadThreads(age);
  const id = `t${age}_` + Date.now();
  const topicPid = "p"+Date.now().toString(36);

  // スレ（議題）を作成
  arr.unshift({
    id, age, title, replies:0, updated_at:new Date().toISOString(), topic_pid: topicPid
  });
  saveThreads(age, arr);

  // 議題ポストを作成（唯一のポスト）
  const post = {
    pid: topicPid,
    body: body,
    anon_id: rid(),
    created_at: new Date().toISOString(),
    is_topic: true,
    title
  };
  savePosts(id, [post]); // スレには最初から議題1件のみ

  if(titleEl) titleEl.value = "";
  if(bodyEl)  bodyEl.value  = "";
  if(status)  status.textContent = "作成しました（ローカル保存）";
  showList(age);
}

// replies
function toggleReply(pid){
  const box = document.getElementById("replyBox_"+pid);
  if(!box) return;
  box.style.display = (box.style.display==="none" || !box.style.display) ? "block" : "none";
}
function submitReply(tid, age, pid){
  const ta = document.getElementById("replyBody_"+pid);
  const status = document.getElementById("replyStatus_"+pid);
  const text = (ta && ta.value || "").trim();
  if(!text){ if(status) status.textContent = "返信内容を入力してください"; return; }

  const map = loadReplies(tid);
  if(!map[pid]) map[pid] = [];
  map[pid].push({ body:text, anon_id:rid(), created_at:new Date().toISOString() });
  saveReplies(tid, map);

  // スレの更新時刻と返信数
  const arr = loadThreads(age);
  const i = arr.findIndex(t=>t.id===tid);
  if(i>=0){ arr[i].replies = (arr[i].replies||0)+1; arr[i].updated_at = new Date().toISOString(); saveThreads(age, arr); }

  if(ta) ta.value = ""; if(status) status.textContent = "返信を投稿しました";
  showThread(tid, age);
}

// init
startApp();
</script>
</body>
</html>
