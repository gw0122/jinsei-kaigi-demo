<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>人生会議（デモ）</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'Hiragino Kaku Gothic ProN','Noto Sans JP','Yu Gothic',sans-serif;margin:0}
  .container{max-width:680px;margin:0 auto;padding:16px}
  h1,h2{margin:0 0 12px 0}
  .grid{display:grid;gap:12px}
  .card{padding:14px;border:1px solid #eee;border-radius:8px;text-decoration:none;display:block}
  .meta{font-size:12px;opacity:.7}
  .thread{display:block;padding:12px 0;border-bottom:1px solid #f1f1f1;text-decoration:none}
  .thread .title{font-weight:600}
  .thread .meta{font-size:12px;opacity:.7;margin-top:4px}
  .post{padding:12px 0;border-bottom:1px solid #f1f1f1}
  .post .meta{font-size:12px;opacity:.7;margin-bottom:6px}
  .post .body{line-height:1.7;word-break:break-word;white-space:pre-wrap}
  .btn{display:inline-block;padding:10px 14px;border:1px solid #ddd;border-radius:6px;cursor:pointer}
  .input, textarea{width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;box-sizing:border-box}
  .empty{padding:24px;text-align:center;color:#999;border:1px dashed #ddd;border-radius:8px}
  nav{padding:10px 16px;border-bottom:1px solid #eee;position:sticky;top:0;background:#fff}
  nav a{text-decoration:none;margin-right:12px}
  .hidden{display:none}
</style>
</head>
<body>
<nav>
  <a href="#/">人生会議</a>
  <a id="navBack" href="javascript:void(0)">戻る</a>
</nav>
<div id="app" class="container"></div>

<script>
// -------- Router (hash-based) --------
function parseHash(){
  const h = location.hash.slice(1) || "/";
  const [path, queryStr] = h.split("?");
  const params = new URLSearchParams(queryStr || "");
  return { path, params };
}
window.addEventListener("hashchange", render);

// -------- Mock data (can be swapped with API later) --------
const THREAD_TITLES = {
  t1: "27歳、仕事やめたい",
  t2: "28歳の貯金額どれくらい？",
  t3: "29歳、結婚の現実を語る"
};
const THREADS = [
  {id:"t1", age:"27-29", title:THREAD_TITLES.t1, replies:42, updated_at:"2025-10-26T12:03:00Z"},
  {id:"t2", age:"27-29", title:THREAD_TITLES.t2, replies:21, updated_at:"2025-10-26T09:41:00Z"},
  {id:"t3", age:"27-29", title:THREAD_TITLES.t3, replies:88, updated_at:"2025-10-25T23:10:00Z"}
];
function fmt(d){ return new Date(d).toLocaleString(); }
function esc(s){return s.replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;",""":"&quot;","'":"&#39;"}[m]));}
function randomId(){return Math.random().toString(36).slice(2,8).toUpperCase();}

// localStorage helpers
function loadPosts(threadId){
  const key = "jk_posts_" + threadId;
  if(!localStorage.getItem(key)){
    const seed = [
      {body:"正直つらい。転職って現実的？", anon_id:"A7XG3F", created_at:"2025-10-26T11:55:00Z"},
      {body:"同じく。まずは副業で収入源作るのが良かった。", anon_id:"9KP2QD", created_at:"2025-10-26T12:10:00Z"}
    ];
    localStorage.setItem(key, JSON.stringify(seed));
  }
  try {
    return JSON.parse(localStorage.getItem(key) || "[]");
  } catch(e){
    return [];
  }
}
function savePost(threadId, post){
  const key = "jk_posts_" + threadId;
  const arr = loadPosts(threadId);
  arr.push(post);
  localStorage.setItem(key, JSON.stringify(arr));
}

// -------- Views --------
function viewTop(){
  return `
    <h1>人生会議</h1>
    <p class="meta">年齢別に本音で語る匿名板。まずは年代を選んでね。</p>
    <div class="grid">
      <a class="card" href="#/list?age=27-29"><b>27–29歳</b><div class="meta">同世代の悩み・仕事・恋愛</div></a>
    </div>
  `;
}
function viewList(age){
  const list = THREADS.filter(t=>t.age===age);
  const items = list.map(t=>`
    <a class="thread" href="#/thread?t=${t.id}">
      <div class="title">${t.title}</div>
      <div class="meta">${t.replies}件｜最終更新 ${fmt(t.updated_at)}</div>
    </a>
  `).join("");
  return `
    <h2>${age} のスレッド</h2>
    <div>${items || `<div class="empty">まだスレがありません</div>`}</div>
    <div style="margin-top:16px"><a class="btn" href="#/">← 年代を選び直す</a></div>
  `;
}
function viewThread(tid){
  const title = THREAD_TITLES[tid] || "スレッド";
  const arr = loadPosts(tid);
  const postsHtml = arr.length ? arr.map(p=>`
    <div class="post">
      <div class="meta">ID:${p.anon_id}｜${fmt(p.created_at)}</div>
      <div class="body">${esc(p.body)}</div>
    </div>
  `).join("") : `<div class="empty">まだ投稿がありません</div>`;
  return `
    <a class="btn" href="javascript:history.back()">← 戻る</a>
    <h2>${title}</h2>
    <div id="posts">${postsHtml}</div>
    <div style="margin-top:16px">
      <h3>投稿する</h3>
      <textarea id="body" class="input" rows="4" placeholder="本文（例：正直つらい。転職って現実的？）"></textarea>
      <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
        <button id="submit" class="btn">送信</button>
        <span id="status" class="meta"></span>
      </div>
    </div>
  `;
}

// -------- Render --------
function render(){
  const {path, params} = parseHash();
  const app = document.getElementById("app");
  if(path === "/list"){
    const age = params.get("age") || "27-29";
    app.innerHTML = viewList(age);
  }else if(path === "/thread"){
    const tid = params.get("t") || "t1";
    app.innerHTML = viewThread(tid);
    // bind submit
    const btn = document.getElementById("submit");
    btn?.addEventListener("click", ()=>{
      const textarea = document.getElementById("body");
      const text = textarea.value.trim();                                      
      const status = document.getElementById("status");
      if(!text){ status.textContent = "本文を入力してください"; return; }
      const post = { body: text, anon_id: randomId(), created_at: new Date().toISOString() };
      savePost(tid, post);
      textarea.value = "";
      status.textContent = "投稿しました（ローカル保存）";
      // re-render thread posts
      const arr = loadPosts(tid);
      document.getElementById("posts").innerHTML = arr.map(p=>`
        <div class="post">
          <div class="meta">ID:${p.anon_id}｜${fmt(p.created_at)}</div>
          <div class="body">${esc(p.body)}</div>
        </div>`).join("");
    });
  }else{
    app.innerHTML = viewTop();
  }
}
document.getElementById("navBack").addEventListener("click", ()=>history.back());
render();
</script>
</body>
</html>
